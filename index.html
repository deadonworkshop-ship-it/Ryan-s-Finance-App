<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0b0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BillsOps">
<title>Bills Checking Ops</title>
<link rel="manifest" href="manifest.json">
<style>
/* ===== GLOBAL STYLES ===== */
body {
  margin: 0;
  font-family: -apple-system, system-ui, sans-serif;
  background: #0b0f14;
  color: #fff;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

/* ===== TYPOGRAPHY & HEADER ===== */
.header {
  display: flex;
  align-items: center;
  padding: 16px;
  background: #0c131d;
  border-bottom: 1px solid #1b2533;
}
.header > .menu {
  font-size: 24px;
  margin-right: 16px;
  cursor: pointer;
}
.header > div:not(.menu) {
  font-size: 22px;
  font-weight: 900;
}

/* ===== CONTAINERS & CARDS ===== */
.container {
  padding: 16px;
  max-width: 600px;
  margin: 0 auto;
}
.card {
  background: #0c131d;
  border: 1px solid #1b2533;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
}
.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #1b2533;
}
.row:last-child {
  border-bottom: none;
}
.big {
  font-size: 32px;
  font-weight: 900;
  margin-top: 8px;
}

/* ===== BUTTONS & INPUTS ===== */
.btn {
  border: 1px solid #2aa6ff;
  background: #0c131d;
  color: white;
  padding: 18px 16px;
  border-radius: 14px;
  font-size: 18px;
  font-weight: 800;
  width: 100%;
  min-height: 64px;
  margin-top: 10px;
  cursor: pointer;
}
.btnSmall, .confirmBtn, .cancelBtn, .primaryBtn {
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  border: 1px solid #1b2533;
  background: #0c131d;
  color: #fff;
}
.confirmBtn { background: #142033; border-color: #2aa6ff; color: #2aa6ff; }
.primaryBtn { background: #2aa6ff; color: #000; border: none; font-weight: 900; }
.cancelBtn { color: #ff5c5c; }

input, select, textarea {
  font-family: inherit;
  font-size: 16px;
  background: #0c131d;
  color: #fff;
  border: 1px solid #1b2533;
  border-radius: 12px;
  padding: 14px;
  box-sizing: border-box;
  width: 100%;
}

/* Toggle Switch */
.toggleSwitch {
  appearance: none; -webkit-appearance: none;
  width: 48px; height: 26px;
  background: #1b2533; border-radius: 13px;
  position: relative; cursor: pointer; outline: none;
}
.toggleSwitch::after {
  content: ""; position: absolute; top: 2px; left: 2px;
  width: 22px; height: 22px; border-radius: 50%;
  background: #9aa7b6; transition: 0.2s;
}
.toggleSwitch:checked { background: #2aa6ff; }
.toggleSwitch:checked::after { transform: translateX(22px); background: #fff; }

.paid-text { text-decoration: line-through; color: #9aa7b6; }

@media (max-width: 520px) {
  .header > div:not(.menu) { font-size: 20px; }
  .update-form { flex-direction: column; align-items: stretch; }
  .update-form > * { width: 100% !important; margin-bottom: 8px; }
}
</style>
</head>
<body>

<div id="fatalErrorBanner" style="display:none; margin:12px; padding:12px; border:1px solid #5a1f1f; background:rgba(180,40,40,0.2); color:#ffd7d7; border-radius:10px; font-size:13px; line-height:1.3;"></div>

<div class="header">
  <div class="menu" id="menuBtn" onclick="toggleMenu()">â˜°</div>
  <div>Ryan's Finance Dashboard</div>
</div>

<div id="menuBackdrop" onclick="toggleMenu()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:50;"></div>
<div id="menuDrawer" style="display:none; position:fixed; top:0; left:0; height:100vh; width:min(360px, 86vw); background:#0c131d; border-right:1px solid #1b2533; z-index:60; padding:14px; overflow:auto;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <div style="font-weight:800;">MENU</div>
    <button class="cancelBtn" style="border:none;" onclick="toggleMenu()">CLOSE</button>
  </div>
  <div class="card" style="margin-bottom:14px;">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">Navigate</div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('home')"><div>Home</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('bills')"><div>Monthly Bills</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('expenses')"><div>Upcoming Expenses</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('debt')"><div>Debt Snapshot</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('investment')"><div>Investments</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('savings')"><div>Savings Accounts</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('networth')"><div>Net Worth Tracker</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('income')"><div>Income Tracker</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('tax')"><div>Tax Withholdings</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('retirement')"><div>Retirement Contributions</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer;" onclick="navigateTo('report')"><div>Yearly Rollup Report</div><div>â€º</div></div>
    <div class="row" style="cursor:pointer; border-top:1px solid #1b2533; padding-top:12px;" onclick="navigateTo('settings')"><div style="color:#9aa7b6;">Settings (Backup)</div><div>â€º</div></div>
  </div>
</div>

<div class="container" style="padding-bottom: 0;">
  <div class="card" id="activeMonthCard">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 14px;">
      <div>
        <div style="font-weight: 800; color:#9aa7b6;">ACTIVE PERIOD</div>
        <div id="currentPhaseBadge" style="font-size:11px; color:#2aa6ff; font-weight:800; margin-top:6px;">TODAY: PHASE --</div>
      </div>
      <button class="btnSmall" style="border-color:#2aa6ff; color:#2aa6ff; padding: 10px 16px; font-weight:900;" onclick="navigateTo('home')">âŒ‚ HOME</button>
    </div>
    <div style="display:flex; gap:10px;">
      <select id="activeYearSelect" style="flex:1; padding:12px;"></select>
      <select id="activeMonthSelect" style="flex:1; padding:12px;"></select>
    </div>
  </div>
</div>

<div class="container page" id="pageHome">
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6; font-weight:800;" id="shouldHaveLabel">YOU SHOULD HAVE</div>
    <div class="big" id="shouldHave">$0.00</div>
    <div style="margin-top:14px;">
      <div style="font-size:12px;color:#9aa7b6;">CURRENT BALANCE</div>
      <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:10px;">
        <div style="text-align:left;">
          <div id="currentBalance" style="font-size:26px;font-weight:800;">$0.00</div>
          <div id="updatedAgo" style="font-size:13px;color:#f5b942;margin-top:4px;">UPDATED â€”</div>
        </div>
        <button class="btnSmall" onclick="openBalanceModal()">UPDATE</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px; border-top:1px solid #1b2533; padding-top:16px;">
      <div>AVAILABLE FOR DEBT</div>
      <div id="avail" style="font-weight:900; font-size:18px;">$0.00</div>
    </div>
  </div>

  <div class="card" style="border-color:#2bd576;">
    <div style="font-size:12px;color:#2bd576;margin-bottom:6px; font-weight:800;">SAFE TO SPEND (MONTHLY)</div>
    <div style="font-size:11px;color:#9aa7b6;margin-bottom:10px; line-height:1.4;">MTD Net Income minus total Monthly Bills minus MTD Retirement.</div>
    <div id="guiltFreeTotal" class="big" style="color:#2bd576; margin-top:0;">$0.00</div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">MONTHLY BILLS PROGRESS</div>
    <div style="width:100%; background:#1b2533; border-radius:8px; height:12px; overflow:hidden;">
      <div id="billProgressBar" style="width:0%; background:#2bd576; height:100%; transition:width 0.4s ease;"></div>
    </div>
    <div id="billProgressText" style="font-size:12px; margin-top:8px; text-align:right; font-weight:800; color:#9aa7b6;">0% Paid</div>
  </div>

  <div class="card" id="nextBillsCard">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">NEXT UP (UNPAID BILLS)</div>
    <div id="nextBillsList"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">QUICK GLANCE TOTALS</div>
    <div class="row"><div>EST. NET WORTH</div><div id="glanceNetWorth" style="font-weight:900; color:#2bd576;">$0</div></div>
    <div class="row"><div>TOTAL PORTFOLIO</div><div id="glancePortfolio" style="font-weight:900;">$0</div></div>
    <div class="row"><div>TOTAL DEBT</div><div id="glanceDebt" style="font-weight:900;">$0</div></div>
    <div class="row"><div>YTD INCOME</div><div id="glanceIncome" style="font-weight:900;">$0</div></div>
    <div class="row"><div>YTD TAXES</div><div id="glanceTaxes" style="font-weight:900;">$0</div></div>
    <div class="row"><div>YTD RETIREMENT</div><div id="glanceRetirement" style="font-weight:900; color:#2aa6ff;">$0</div></div>
  </div>
</div>

<div class="container page" id="pageBills" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Monthly Bills</div>
      <div style="display:flex; gap:8px;">
        <button class="btnSmall" onclick="showAddBillForm()">+ BILL</button>
        <button class="btnSmall" style="border-color:#f5b942; color:#f5b942;" onclick="showAddDebtBillForm()">+ DEBT PMT</button>
      </div>
    </div>
  </div>

  <div class="card" id="addBillForm" style="display:none; flex-direction:column; gap:10px;">
    <div style="font-size:12px;color:#2aa6ff;font-weight:800;">ADD REGULAR BILL</div>
    <input id="newBillName" placeholder="Bill Name (e.g., Trash Collection)" />
    <input id="newBillAmount" inputmode="decimal" placeholder="Amount" />
    <select id="newBillPhase">
      <option value="1">Phase 1 (Autodrafts 1st-15th)</option>
      <option value="2">Phase 2 (Autodrafts 16th+)</option>
    </select>
    <div style="display:flex; gap:10px;">
      <button class="confirmBtn" style="flex:1;" onclick="saveNewBill()">SAVE</button>
      <button class="cancelBtn" style="flex:1;" onclick="hideAddBillForm()">CANCEL</button>
    </div>
  </div>

  <div class="card" id="addDebtBillForm" style="display:none; flex-direction:column; gap:10px;">
    <div style="font-size:12px;color:#f5b942;font-weight:800;">ADD DEBT PAYMENT</div>
    <select id="newDebtBillName"></select>
    <input id="newDebtBillAmount" inputmode="decimal" placeholder="Payment Amount" />
    <select id="newDebtBillPhase">
      <option value="1">Phase 1 (Autodrafts 1st-15th)</option>
      <option value="2">Phase 2 (Autodrafts 16th+)</option>
    </select>
    <div style="display:flex; gap:10px;">
      <button class="confirmBtn" style="flex:1; border-color:#f5b942; color:#f5b942;" onclick="saveNewDebtBill()">SAVE</button>
      <button class="cancelBtn" style="flex:1;" onclick="hideAddDebtBillForm()">CANCEL</button>
    </div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">PHASE 1 (1st - 15th)</div>
    <div id="phase1BillsList"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">PHASE 2 (16th - End)</div>
    <div id="phase2BillsList"></div>
  </div>
</div>

<div class="container page" id="pageExpenses" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Upcoming Expenses</div>
      <button class="btnSmall" onclick="showExpenseForm()">+ EXPENSE</button>
    </div>
  </div>

  <div class="card" id="addExpenseForm" style="display:none; flex-direction:column; gap:10px;">
    <div style="font-size:12px;color:#ff5c5c;font-weight:800;">ADD LARGE EXPENSE</div>
    <input id="newExpenseName" placeholder="Expense (e.g., Vacation, Roof Repair)" />
    <input id="newExpenseAmount" inputmode="decimal" placeholder="Amount" />
    <div style="display:flex; gap:10px;">
      <button class="confirmBtn" style="flex:1; border-color:#ff5c5c; color:#ff5c5c;" onclick="saveExpense()">SAVE</button>
      <button class="cancelBtn" style="flex:1;" onclick="hideExpenseForm()">CANCEL</button>
    </div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">GLOBAL EXPENSE LIST</div>
    <div id="expensesList"></div>
    <div class="row" style="border-top:1px solid #1b2533; padding-top:12px; margin-top:12px;">
       <div style="font-weight:900;">UNPAID TOTAL</div>
       <div id="expensesTotal" style="font-weight:900; color:#ff5c5c;">$0.00</div>
    </div>
  </div>
</div>

<div class="container page" id="pageDebt" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Debt Snapshot</div>
    </div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">UPDATE DEBT BALANCE</div>
    <div class="update-form" style="display:flex; gap:10px; margin-bottom:12px;">
      <select id="debtAccountSelect" style="flex:2;"></select>
      <input id="debtAmountInput" inputmode="decimal" placeholder="Balance" style="flex:1;" />
      <button class="confirmBtn" style="width:auto;" onclick="updateSnapshotTracker('debt')">UPDATE</button>
    </div>
    <div class="row"><div>TOTAL OUTSTANDING DEBT</div><div id="debtTotal" class="big" style="margin-top:0;">$0.00</div></div>
    <div id="debtList" style="margin-top:16px;"></div>
  </div>

  <div class="card" style="border-color:#f5b942;">
    <div style="font-size:12px;color:#f5b942;margin-bottom:10px; font-weight:800;">DEBT PAYOFF ESTIMATOR</div>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <select id="payoffAccountSelect" onchange="loadPayoffBalance()"></select>
      <input id="payoffBalance" inputmode="decimal" placeholder="Current Balance (Auto-fills)" />
      <div style="display:flex; gap:10px;">
        <input id="payoffRate" inputmode="decimal" placeholder="Interest Rate (%)" style="flex:1;" />
        <input id="payoffMin" inputmode="decimal" placeholder="Min Payment ($)" style="flex:1;" />
      </div>
      <input id="payoffExtra" inputmode="decimal" placeholder="Extra Payment per Month ($)" />
      <button class="confirmBtn" style="border-color:#f5b942; color:#f5b942;" onclick="calculatePayoff()">CALCULATE PAYOFF</button>
      <div id="payoffResult" style="margin-top:10px; font-weight:800; font-size:16px; color:#2bd576; text-align:center;"></div>
    </div>
  </div>

  <div class="card" style="margin-top: 16px;">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">DEBT REDUCTION</div>
    <div id="debtGraphContainer" style="width: 100%; height: 160px; position: relative;"></div>
  </div>
</div>

<div class="container page" id="pageInvestment" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Investments Snapshot</div>
    </div>
  </div>
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">UPDATE INVESTMENT BALANCE</div>
    <div class="update-form" style="display:flex; gap:10px; margin-bottom:12px;">
      <select id="investmentAccountSelect" style="flex:2;"></select>
      <input id="investmentAmountInput" inputmode="decimal" placeholder="Balance" style="flex:1;" />
      <button class="confirmBtn" style="width:auto;" onclick="updateSnapshotTracker('investment')">UPDATE</button>
    </div>
    <div class="row"><div>TOTAL INVESTMENTS</div><div id="investmentTotal" class="big" style="margin-top:0;">$0.00</div></div>
    <div id="investmentList" style="margin-top:16px;"></div>
  </div>
  
  <div class="card" style="margin-top: 16px;">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">PORTFOLIO GROWTH</div>
    <div id="investmentGraphContainer" style="width: 100%; height: 160px; position: relative;"></div>
  </div>
</div>

<div class="container page" id="pageSavings" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Savings Accounts</div>
    </div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">UPDATE SAVINGS BALANCE</div>
    <div class="update-form" style="display:flex; gap:10px; margin-bottom:12px;">
      <select id="savingsAccountSelect" style="flex:2;"></select>
      <input id="savingsAmountInput" inputmode="decimal" placeholder="Balance" style="flex:1;" />
      <button class="confirmBtn" style="width:auto;" onclick="updateSnapshotTracker('savings')">UPDATE</button>
    </div>
    <div class="row"><div>TOTAL SAVINGS</div><div id="savingsTotal" class="big" style="margin-top:0;">$0.00</div></div>
    <div id="savingsList" style="margin-top:16px;"></div>
  </div>

  <div class="card">
    <div class="row" style="border:none; padding:0; margin-bottom:10px;">
      <div style="font-size:12px;color:#9aa7b6; font-weight:800;">SINKING FUNDS / GOALS</div>
      <button class="btnSmall" onclick="showGoalForm()">+ GOAL</button>
    </div>
    
    <div id="addGoalForm" style="display:none; flex-direction:column; gap:10px; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #1b2533;">
      <select id="goalAccountSelect"></select>
      <input id="goalLabelInput" placeholder="Goal Name (e.g., Vacation, AC-130 Sleeve)" />
      <input id="goalTargetInput" inputmode="decimal" placeholder="Target Amount ($)" />
      <div style="display:flex; gap:10px;">
        <button class="confirmBtn" style="flex:1;" onclick="saveSavingsGoal()">SAVE</button>
        <button class="cancelBtn" style="flex:1;" onclick="hideGoalForm()">CANCEL</button>
      </div>
    </div>

    <div id="savingsGoalsList"></div>
  </div>
  
  <div class="card" style="margin-top: 16px;">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">SAVINGS GROWTH</div>
    <div id="savingsGraphContainer" style="width: 100%; height: 160px; position: relative;"></div>
  </div>
</div>

<div class="container page" id="pageNetworth" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800;">Net Worth Tracker</div>
    </div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">UPDATE ASSET ASSUMPTIONS</div>
    <div class="update-form" style="display:flex; gap:10px; margin-bottom:12px;">
      <select id="assumptionsAccountSelect" style="flex:2;"></select>
      <input id="assumptionsAmountInput" inputmode="decimal" placeholder="Value" style="flex:1;" />
      <button class="confirmBtn" style="width:auto;" onclick="updateSnapshotTracker('assumptions')">UPDATE</button>
    </div>
    <div id="assumptionsList" style="margin-top:16px;"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">NET WORTH BREAKDOWN</div>
    <div class="row"><div>Total Assets</div><div id="nwAssets">$0.00</div></div>
    <div class="row"><div>Total Liabilities</div><div id="nwLiabilities">$0.00</div></div>
    <div class="row" style="border-top:1px solid #1b2533; padding-top:12px;">
       <div style="font-weight:900;">ESTIMATED NET WORTH</div>
       <div id="nwTotal" style="font-weight:900; font-size:20px; color:#2bd576;">$0.00</div>
    </div>
  </div>

  <div class="card" style="margin-top: 16px;">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">NET WORTH GROWTH</div>
    <div id="networthGraphContainer" style="width: 100%; height: 160px; position: relative;"></div>
  </div>
</div>

<div class="container page" id="pageIncome" style="display:none;">
  <div class="card">
    <div style="font-weight:800; font-size:18px;">Income Tracker</div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">ADD NEW INCOME TRANSACTION</div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:12px;">
      <select id="incomeAccountSelect" onchange="toggleIncomeMisc()"></select>
      <input id="incomeMiscInput" placeholder="Describe source (e.g., Grandma check)" style="display:none;" />
      <div style="display:flex; gap:10px;">
        <input id="incomeAmountInput" inputmode="decimal" placeholder="Amount" style="flex:1;" />
        <input id="incomeDateInput" type="date" style="flex:1;" />
      </div>
      <button class="confirmBtn" onclick="addFlowTransaction('income')">ADD INCOME</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="border:none; padding-bottom:4px;">
      <div style="font-size:12px;color:#9aa7b6;">MONTH-TO-DATE INCOME</div>
      <div id="incomeTotal" class="big" style="margin-top:0;">$0.00</div>
    </div>
    <div id="incomeCategoryTotals" style="margin-top:12px; padding-top:12px; border-top:1px solid #1b2533; font-size:14px; font-weight:700;"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">CHRONOLOGICAL LIST</div>
    <div id="incomeTransactionList"></div>
  </div>
</div>

<div class="container page" id="pageTax" style="display:none;">
  <div class="card">
    <div style="font-weight:800; font-size:18px;">Tax Withholdings</div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">ADD NEW TAX TRANSACTION</div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:12px;">
      <select id="taxAccountSelect"></select>
      <div style="display:flex; gap:10px;">
        <input id="taxAmountInput" inputmode="decimal" placeholder="Amount" style="flex:1;" />
        <input id="taxDateInput" type="date" style="flex:1;" />
      </div>
      <button class="confirmBtn" onclick="addFlowTransaction('tax')">ADD TAX ENTRY</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="border:none; padding-bottom:4px;">
      <div style="font-size:12px;color:#9aa7b6;">MONTH-TO-DATE TAXES</div>
      <div id="taxTotal" class="big" style="margin-top:0;">$0.00</div>
    </div>
    <div id="taxCategoryTotals" style="margin-top:12px; padding-top:12px; border-top:1px solid #1b2533; font-size:14px; font-weight:700;"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">CHRONOLOGICAL LIST</div>
    <div id="taxTransactionList"></div>
  </div>
</div>

<div class="container page" id="pageRetirement" style="display:none;">
  <div class="card">
    <div style="font-weight:800; font-size:18px;">Retirement Contributions</div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">LOG CONTRIBUTION</div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:12px;">
      <select id="retirementAccountSelect"></select>
      <div style="display:flex; gap:10px;">
        <input id="retirementAmountInput" inputmode="decimal" placeholder="Amount" style="flex:1;" />
        <input id="retirementDateInput" type="date" style="flex:1;" />
      </div>
      <button class="confirmBtn" onclick="addFlowTransaction('retirement')">ADD CONTRIBUTION</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="border:none; padding-bottom:4px;">
      <div style="font-size:12px;color:#9aa7b6;">MONTHLY COMPLETE TOTAL</div>
      <div id="retirementTotal" class="big" style="margin-top:0; color:#2aa6ff;">$0.00</div>
    </div>
    <div id="retirementCategoryTotals" style="margin-top:12px; padding-top:12px; border-top:1px solid #1b2533; font-size:14px; font-weight:700;"></div>
  </div>

  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">CHRONOLOGICAL LIST</div>
    <div id="retirementTransactionList"></div>
  </div>
</div>

<div class="container page" id="pageReport" style="display:none;">
  <div class="card">
    <div class="row" style="border:none; padding:0;">
      <div style="font-weight:800; font-size:18px;">Yearly Rollup Report</div>
    </div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">SELECT REPORT YEAR</div>
    <select id="reportYearSelect" style="width:100%; padding:14px;" onchange="generateYearlyReport()"></select>
  </div>
  
  <div id="reportContainer"></div>
</div>

<div class="container page" id="pageSettings" style="display:none;">
  <div class="card">
    <div style="font-weight:800; font-size:18px;">Settings & Backup</div>
  </div>
  
  <div class="card">
    <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">DATA EXPORT</div>
    <div style="font-size:13px; margin-bottom:12px; line-height:1.4;">Download a complete backup of all your financial history to your phone or computer.</div>
    <button class="primaryBtn" style="width:100%; padding:14px;" onclick="exportData()">â¬‡ EXPORT BACKUP FILE</button>
  </div>

  <div class="card" style="border-color:#ff5c5c;">
    <div style="font-size:12px;color:#ff5c5c;margin-bottom:10px; font-weight:800;">DATA IMPORT</div>
    <div style="font-size:13px; margin-bottom:12px; line-height:1.4;">Restore your app from a previous backup file. <b>Warning: This will overwrite your current data.</b></div>
    <input type="file" id="importFileInput" accept=".json" style="margin-bottom:10px; padding:10px; font-size:14px;" />
    <button class="confirmBtn" style="width:100%; border-color:#ff5c5c; color:#ff5c5c;" onclick="importData()">â¬† IMPORT DATA</button>
  </div>
</div>

<div id="balBackdrop" onclick="closeBalanceModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:90;"></div>
<div id="balModal" style="display:none; position:fixed; inset:0; z-index:100; padding:16px; align-items:center; justify-content:center;">
  <div style="width:100%; max-width:420px; background:#101722; border:1px solid #1b2533; border-radius:14px; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #1b2533;">
      <div style="font-weight:900;">Update Current Balance</div>
      <button class="cancelBtn" onclick="closeBalanceModal()" style="border:none; padding:0;">CLOSE</button>
    </div>
    <div style="padding:14px 16px;">
      <input id="balInput" type="text" inputmode="decimal" placeholder="e.g. 5195.91" />
      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="primaryBtn" style="flex:1;" onclick="saveBalanceFromModal()">SAVE</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>

<script>
// ==========================================
// ðŸš¨ PASTE YOUR UPDATED BASELINE_BILLS HERE ðŸš¨
// ==========================================
const BASELINE_BILLS = [
  { name: "Land Payment", amount: 907.50, phase: 1 },
  { name: "T-Mobile", amount: 357.34, phase: 1 },
  { name: "Mortgage", amount: 2406.28, phase: 1 },
  { name: "AAFMAA", amount: 33.35, phase: 1 },
  { name: "Travelers Insurance", amount: 392.75, phase: 1 },
  { name: "TRICARE", amount: 286.66, phase: 1 }, 
  { name: "Express Scripts", amount: 14.00, phase: 1 },
  { name: "Car Payment - Highlander", amount: 229.03, phase: 1 },
  { name: "Car Payment - Tesla", amount: 569.00, phase: 1 },
  { name: "Amelia 529", amount: 100.00, phase: 2 },
  { name: "Julia 529", amount: 100.00, phase: 2 },
  { name: "Netflix", amount: 27.39, phase: 2 },
  { name: "Denver Water", amount: 61.06, phase: 2 },
  {name:"Travelers Insurance",amount:378.50,phase:2},
 {name:"Xcel Energy",amount:300.00,phase:2},
  { name: "BAM Internet", amount: 80.10, phase: 2 }
];

// ==========================================
// ðŸš¨ YOUR DEFAULT TRACKER CATEGORIES ðŸš¨
// ==========================================
const DEFAULT_CATEGORIES = {
  investment: [
    "TSP", "Ryan Roth IRA - Decade Perspective", "Ashley Schwab Roth IRA", 
    "Ashley Schwab Rollover IRA", "Ryan Schwab Brokerage", "Ryan Schwab Brokerage 2", 
    "Ryan PCRA Trust - Bonfire", "UC Health Fidelity", "Ashley Old IRA", "Robinhood"
  ],
  debt: [
    "House Mortgage", "Land Mortgage", "Tesla Loan", "Highlander Loan", 
    "USAA Signature Credit Card", "USAA Platinum Credit Card", "AMEX Platinum Card", 
    "AMEX Blue Cash Credit Card", "AMEX Delta Credit Card", "AMEX Bonvoy Card", 
    "Amazon Prime Credit Card", "Amazon Prime Business Credit Card" 
  ],
  savings: [
    "USAA Savings", "Marcus Savings", "Discover Savings", "SOFI Savings", "BlueVine", "Cash"
  ],
  assumptions: [
    "Home Value", "Land Value"
  ],
  income: ["USAF", "VA", "United", "UC Health", "FastCap", "Miscellaneous"],
  tax: [
    "USAF State", "USAF Federal", "UC Health State", "UC Health Federal", 
    "United State", "United Federal", "Extra State", "Extra Federal"
  ],
  retirement: [
    "Ryan Roth IRA - Decade Perspective", "Ryan Traditional IRA - Decade Perspective", 
    "Ryan Roth IRA - LRC", "Ryan Traditional IRA - LRC", 
    "Ryan Roth TSP", "Ryan Traditional TSP", 
    "Ryan Roth PRAP", "Ryan Traditional PRAP", 
    "Ashley Traditional IRA - LRC", "Ashley Roth IRA - LRC", 
    "Ashley 403b", "Ashley 457b", "Ashley 401a"
  ]
};

// ==========================================
// ðŸš¨ YOUR PRE-LOADED FEBRUARY BALANCES & GOALS ðŸš¨
// ==========================================
const PRELOADED_BALANCES = {
  investment: {
    "TSP": 279092.82, "Ryan Roth IRA - Decade Perspective": 126288.16, "Ashley Schwab Roth IRA": 64048.44, 
    "Ashley Schwab Rollover IRA": 37224.24, "Ryan Schwab Brokerage": 80062.70, "Ryan Schwab Brokerage 2": 49340.98, 
    "Ryan PCRA Trust - Bonfire": 102100.97, "UC Health Fidelity": 69699.20, "Ashley Old IRA": 18368.37, "Robinhood": 45451.93
  },
  debt: {
    "House Mortgage": 550000.00, "Land Mortgage": 91750.34, "Tesla Loan": 30918.79, "Highlander Loan": 5581.51, 
    "AMEX Bonvoy Card": 3249.74, "Amazon Prime Business Credit Card": 1471.18, "Amazon Prime Credit Card": 251.67
  },
  savings: {
    "USAA Savings": 3000, "Marcus Savings": 174.45, "Discover Savings": 204.79, "SOFI Savings": 810.32, "BlueVine": 0, "Cash": 0
  },
  assumptions: {
    "Home Value": 750000, "Land Value": 175000
  }
};

const PRELOADED_GOALS = {
  "Discover Savings": { label: "AC-130 Arm Sleeve", target: 3500 },
  "USAA Savings": { label: "Emergency Fund", target: 10000 }
};

// ===== 1. CORE STATE & STORAGE (v12 - SAVINGS GOALS & ESTIMATORS) =====
const STORAGE_PREFIX = "bills_ops_v12_";
const getStorage = (key, defaultVal) => {
  try { return JSON.parse(localStorage.getItem(STORAGE_PREFIX + key)) || defaultVal; } 
  catch { return defaultVal; }
};
const setStorage = (key, val) => localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(val));

function initTrackersForMonth(yyyyMM) {
  // Snapshot Trackers
  ['investment', 'debt', 'savings', 'assumptions'].forEach(tracker => {
    const key = `${tracker}_${yyyyMM}`;
    let data = getStorage(key, null);
    
    if (!data) {
      let availableMonths = [];
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith(STORAGE_PREFIX + tracker + "_")) availableMonths.push(k.split(tracker + "_")[1]);
      }
      availableMonths.sort();
      let prevMonth = availableMonths.reverse().find(m => m < yyyyMM);

      if (prevMonth) {
        data = getStorage(`${tracker}_${prevMonth}`, {});
      } else {
        data = {};
        DEFAULT_CATEGORIES[tracker].forEach(cat => data[cat] = 0);
        if (yyyyMM === "2026-02" && PRELOADED_BALANCES[tracker]) {
          Object.keys(PRELOADED_BALANCES[tracker]).forEach(k => data[k] = PRELOADED_BALANCES[tracker][k]);
        }
      }
      setStorage(key, data);
    }
    const select = document.getElementById(`${tracker}AccountSelect`);
    if (select) {
      select.innerHTML = "";
      Object.keys(data).forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }
  });

  // Flow Trackers 
  ['income', 'tax', 'retirement'].forEach(tracker => {
    const key = `${tracker}_${yyyyMM}`;
    let data = getStorage(key, null);
    if (!data || !Array.isArray(data)) {
      data = []; 
      setStorage(key, data);
    }
    const select = document.getElementById(`${tracker}AccountSelect`);
    if (select) {
      select.innerHTML = "";
      DEFAULT_CATEGORIES[tracker].forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }
  });

  // Unique Dropdowns (Bills, Debt Payoff, Savings Goals)
  const populateSpecialDropdown = (elId, categories, suffix = "") => {
    const el = document.getElementById(elId);
    if (el) {
      el.innerHTML = "";
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat + suffix;
        el.appendChild(opt);
      });
    }
  };
  
  populateSpecialDropdown('newDebtBillName', DEFAULT_CATEGORIES.debt, " Payment");
  populateSpecialDropdown('payoffAccountSelect', DEFAULT_CATEGORIES.debt);
  populateSpecialDropdown('goalAccountSelect', DEFAULT_CATEGORIES.savings);

  // Initialize Savings Goals Object globally
  let goals = getStorage("savings_goals", null);
  if (!goals) setStorage("savings_goals", PRELOADED_GOALS);
}

// ===== 2. DATE & SPLIT MONTH/YEAR LOGIC =====
function initActiveMonthUI() {
  const yearSelect = document.getElementById("activeYearSelect");
  const monthSelect = document.getElementById("activeMonthSelect");
  const reportYearSelect = document.getElementById("reportYearSelect");

  const d = new Date();
  const currentYear = d.getFullYear();
  const currentMonth = String(d.getMonth() + 1).padStart(2, '0');

  const populateYears = (sel, defaultVal) => {
    if(!sel) return;
    sel.innerHTML = "";
    for (let y = 2024; y <= currentYear + 2; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      sel.appendChild(opt);
    }
    sel.value = defaultVal;
  };

  populateYears(yearSelect, currentYear);
  populateYears(reportYearSelect, currentYear);

  if(monthSelect) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    monthSelect.innerHTML = "";
    monthNames.forEach((name, i) => {
      const val = String(i + 1).padStart(2, '0');
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = name;
      monthSelect.appendChild(opt);
    });
    monthSelect.value = currentMonth;
  }

  const handleChange = () => {
    initTrackersForMonth(getActiveMonth()); 
    renderBills();
    renderExpenses();
    renderDashboard();
    ['investment', 'debt', 'savings', 'assumptions'].forEach(id => renderSnapshotList(id));
    ['income', 'tax', 'retirement'].forEach(id => renderFlowList(id));
    renderNetWorth();
    
    if (document.getElementById("pageInvestment").style.display === "block") setTimeout(() => renderSnapshotGraph('investment', 'investmentGraphContainer', '#2aa6ff'), 10);
    if (document.getElementById("pageDebt").style.display === "block") {
      setTimeout(() => renderSnapshotGraph('debt', 'debtGraphContainer', '#ff5c5c'), 10);
      loadPayoffBalance();
    }
    if (document.getElementById("pageSavings").style.display === "block") setTimeout(() => renderSnapshotGraph('savings', 'savingsGraphContainer', '#f5b942'), 10);
    if (document.getElementById("pageNetworth").style.display === "block") setTimeout(renderNetWorthGraph, 10);
  };

  if(yearSelect) yearSelect.addEventListener("change", handleChange);
  if(monthSelect) monthSelect.addEventListener("change", handleChange);
}

function getActiveMonth() { 
  const y = document.getElementById("activeYearSelect")?.value || new Date().getFullYear();
  const m = document.getElementById("activeMonthSelect")?.value || String(new Date().getMonth() + 1).padStart(2, '0');
  return `${y}-${m}`;
}

// ===== 3. BALANCE MODAL LOGIC =====
function openBalanceModal() {
  document.getElementById("balBackdrop").style.display = "block";
  document.getElementById("balModal").style.display = "flex";
  document.getElementById("balInput").value = getStorage("current_balance", "0.00");
  document.getElementById("balInput").focus();
}

function closeBalanceModal() {
  document.getElementById("balBackdrop").style.display = "none";
  document.getElementById("balModal").style.display = "none";
}

function saveBalanceFromModal() {
  const raw = document.getElementById("balInput").value;
  const val = parseFloat(raw.replace(/[^0-9.\-]/g, ""));
  if (!Number.isNaN(val)) {
    setStorage("current_balance", val.toFixed(2));
    setStorage("balance_updated_at", Date.now());
    renderDashboard();
  }
  closeBalanceModal();
}

// ===== 4. FORMATTING =====
function formatMoney(amount) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0); }

// ===== 5. UI RENDERERS (HOME DASHBOARD & GUILT-FREE MATH) =====
function sumSnapshot(tracker, month) {
  const data = getStorage(`${tracker}_${month}`, {});
  return Object.values(data).reduce((s, v) => s + v, 0);
}

function sumFlowMonth(tracker, month) {
  const data = getStorage(`${tracker}_${month}`, []);
  return data.reduce((s, item) => s + item.amount, 0);
}

function renderDashboard() {
  const bal = parseFloat(getStorage("current_balance", 0));
  const updatedTs = getStorage("balance_updated_at", null);
  const activeMonth = getActiveMonth();
  
  document.getElementById("currentBalance").textContent = formatMoney(bal);
  if (updatedTs) {
    const diffMins = Math.floor((Date.now() - updatedTs) / 60000);
    let timeString = diffMins < 60 ? `${diffMins}m ago` : `${Math.floor(diffMins/60)}h ago`;
    if(diffMins === 0) timeString = "Just now";
    document.getElementById("updatedAgo").textContent = `UPDATED â€” ${timeString}`;
  }

  const monthBills = getStorage("bills", []).filter(b => b.month === activeMonth);
  const today = new Date();
  const sysPhase = today.getDate() <= 15 ? 1 : 2;
  document.getElementById("currentPhaseBadge").textContent = `TODAY: PHASE ${sysPhase} ${sysPhase===1 ? "(1st - 15th)" : "(16th - End)"}`;

  // Checking Math
  const targetPhaseBills = monthBills.filter(b => b.phase === sysPhase && !b.paid);
  const unpaidTargetTotal = targetPhaseBills.reduce((sum, b) => sum + b.amount, 0);
  document.getElementById("shouldHaveLabel").textContent = `YOU SHOULD HAVE (PHASE ${sysPhase} UNPAID)`;
  document.getElementById("shouldHave").textContent = formatMoney(unpaidTargetTotal); 
  
  const available = bal - unpaidTargetTotal;
  const availEl = document.getElementById("avail");
  availEl.textContent = formatMoney(available);
  availEl.style.color = available >= 0 ? "#2bd576" : "#ff5c5c"; 

  // Guilt-Free Spending Math
  const mtdIncome = sumFlowMonth('income', activeMonth);
  const mtdTaxes = sumFlowMonth('tax', activeMonth);
  const mtdRetirement = sumFlowMonth('retirement', activeMonth);
  const totalMonthBillsFootprint = monthBills.reduce((s, b) => s + b.amount, 0);
  const guiltFree = (mtdIncome - mtdTaxes) - totalMonthBillsFootprint - mtdRetirement;
  document.getElementById("guiltFreeTotal").textContent = formatMoney(guiltFree);

  // Bill Progress
  const paidMonthBills = monthBills.filter(b => b.paid).reduce((s, b) => s + b.amount, 0);
  const pct = totalMonthBillsFootprint === 0 ? 0 : Math.round((paidMonthBills / totalMonthBillsFootprint) * 100);
  document.getElementById("billProgressBar").style.width = `${pct}%`;
  document.getElementById("billProgressText").textContent = `${pct}% Paid (${formatMoney(paidMonthBills)} / ${formatMoney(totalMonthBillsFootprint)})`;

  // Next 3 Bills
  const unpaidAll = monthBills.filter(b => !b.paid).sort((a,b) => a.phase - b.phase); 
  const next3 = unpaidAll.slice(0, 3);
  const nextList = document.getElementById("nextBillsList");
  nextList.innerHTML = "";
  if(next3.length === 0) {
    nextList.innerHTML = "<div style='color:#2bd576; font-size:14px; font-weight:800; padding-top:8px;'>All bills paid for the month!</div>";
  } else {
    next3.forEach(b => {
      const tagColor = b.phase === 1 ? "#2aa6ff" : "#9aa7b6";
      nextList.innerHTML += `
        <div class="row" style="padding:10px 0; align-items:center;">
          <div>
            <div style="font-weight:800;">${b.name}</div>
            <div style="font-size:11px; color:${tagColor}; font-weight:700; margin-top:2px;">PHASE ${b.phase}</div>
          </div>
          <div style="font-weight:900; font-size:16px;">${formatMoney(b.amount)}</div>
        </div>
      `;
    });
  }

  // Quick Glance Updates
  const sumFlowYTD = (tracker) => {
    const year = activeMonth.split('-')[0];
    let total = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(`${STORAGE_PREFIX}${tracker}_${year}-`)) {
        const data = JSON.parse(localStorage.getItem(key)) || [];
        total += data.reduce((s, item) => s + item.amount, 0);
      }
    }
    return total;
  };
  
  const totalAssets = sumSnapshot('investment', activeMonth) + sumSnapshot('savings', activeMonth) + sumSnapshot('assumptions', activeMonth);
  const totalLiabilities = sumSnapshot('debt', activeMonth);
  
  document.getElementById("glanceNetWorth").textContent = formatMoney(totalAssets - totalLiabilities);
  document.getElementById("glancePortfolio").textContent = formatMoney(sumSnapshot('investment', activeMonth));
  document.getElementById("glanceDebt").textContent = formatMoney(totalLiabilities);
  document.getElementById("glanceIncome").textContent = formatMoney(sumFlowYTD('income'));
  document.getElementById("glanceTaxes").textContent = formatMoney(sumFlowYTD('tax'));
  document.getElementById("glanceRetirement").textContent = formatMoney(sumFlowYTD('retirement'));
}

function renderNetWorth() {
  const activeMonth = getActiveMonth();
  const totalAssets = sumSnapshot('investment', activeMonth) + sumSnapshot('savings', activeMonth) + sumSnapshot('assumptions', activeMonth);
  const totalLiabilities = sumSnapshot('debt', activeMonth);
  
  const elAssets = document.getElementById('nwAssets');
  const elLiabilities = document.getElementById('nwLiabilities');
  const elTotal = document.getElementById('nwTotal');
  
  if(elAssets) elAssets.textContent = formatMoney(totalAssets);
  if(elLiabilities) elLiabilities.textContent = formatMoney(totalLiabilities);
  if(elTotal) elTotal.textContent = formatMoney(totalAssets - totalLiabilities);
}

// ===== 6. MONTHLY BILLS LOGIC =====
function renderBills() {
  const activeMonth = getActiveMonth();
  let allBills = getStorage("bills", []);
  let monthBills = allBills.filter(b => b.month === activeMonth);
  if (monthBills.length === 0) {
    const newBills = BASELINE_BILLS.map((b, i) => ({ ...b, month: activeMonth, paid: false, id: Date.now() + i }));
    allBills = allBills.concat(newBills);
    setStorage("bills", allBills);
    monthBills = newBills;
  }
  const phase1List = document.getElementById("phase1BillsList");
  const phase2List = document.getElementById("phase2BillsList");
  phase1List.innerHTML = ""; phase2List.innerHTML = "";
  monthBills.forEach(bill => {
    const row = document.createElement("div");
    row.className = "row";
    const textClass = bill.paid ? "paid-text" : "";
    row.innerHTML = `
      <div style="display:flex; align-items:center; width:100%; gap:12px;">
        <input type="checkbox" class="toggleSwitch" ${bill.paid ? 'checked' : ''} onchange="toggleBillPaid(${bill.id})" style="flex-shrink:0;">
        <div style="flex:1; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:800; font-size:16px;" class="${textClass}">${bill.name}</div>
          <div style="font-weight:900; font-size:18px;" class="${textClass}">${formatMoney(bill.amount)}</div>
        </div>
        <button class="cancelBtn" style="border:none; padding:8px; font-size:16px; font-weight:bold; flex-shrink:0;" onclick="deleteBill(${bill.id})">âœ•</button>
      </div>
    `;
    if (bill.phase === 1) phase1List.appendChild(row);
    else phase2List.appendChild(row);
  });
  renderDashboard(); 
}

function showAddBillForm() { 
  document.getElementById("addBillForm").style.display = "flex"; 
  document.getElementById("addDebtBillForm").style.display = "none"; 
}
function hideAddBillForm() { document.getElementById("addBillForm").style.display = "none"; }
function saveNewBill() {
  const name = document.getElementById("newBillName").value;
  const amount = parseFloat(document.getElementById("newBillAmount").value || 0);
  const phase = parseInt(document.getElementById("newBillPhase").value);
  if (!name || amount <= 0) return alert("Please enter a valid bill name and amount.");
  const allBills = getStorage("bills", []);
  allBills.push({ id: Date.now(), name, amount, phase, paid: false, month: getActiveMonth() });
  setStorage("bills", allBills);
  document.getElementById("newBillName").value = "";
  document.getElementById("newBillAmount").value = "";
  hideAddBillForm();
  renderBills();
}

function showAddDebtBillForm() { 
  document.getElementById("addDebtBillForm").style.display = "flex"; 
  document.getElementById("addBillForm").style.display = "none"; 
}
function hideAddDebtBillForm() { document.getElementById("addDebtBillForm").style.display = "none"; }
function saveNewDebtBill() {
  const name = document.getElementById("newDebtBillName").value;
  const amount = parseFloat(document.getElementById("newDebtBillAmount").value || 0);
  const phase = parseInt(document.getElementById("newDebtBillPhase").value);
  if (amount <= 0) return alert("Please enter a valid payment amount.");
  const allBills = getStorage("bills", []);
  allBills.push({ id: Date.now(), name, amount, phase, paid: false, month: getActiveMonth() });
  setStorage("bills", allBills);
  document.getElementById("newDebtBillAmount").value = "";
  hideAddDebtBillForm();
  renderBills();
}

function toggleBillPaid(id) {
  const allBills = getStorage("bills", []);
  const bill = allBills.find(b => b.id === id);
  if (bill) { bill.paid = !bill.paid; setStorage("bills", allBills); renderBills(); }
}
function deleteBill(id) {
  if (!confirm("Remove this bill?")) return;
  let allBills = getStorage("bills", []);
  allBills = allBills.filter(b => b.id !== id);
  setStorage("bills", allBills);
  renderBills();
}

// ===== 7. GLOBAL EXPENSES LOGIC =====
function renderExpenses() {
  const exps = getStorage("global_expenses", []);
  const list = document.getElementById("expensesList");
  if(!list) return;
  list.innerHTML = "";
  let totalUnpaid = 0;
  
  if(exps.length === 0) {
    list.innerHTML = "<div style='color:#9aa7b6; font-size:12px; margin-top:10px;'>No upcoming expenses logged.</div>";
  }
  
  exps.forEach(e => {
    if (!e.paid) totalUnpaid += e.amount;
    const textClass = e.paid ? "paid-text" : "";
    list.innerHTML += `
      <div style="display:flex; align-items:center; width:100%; gap:12px;" class="row">
        <input type="checkbox" class="toggleSwitch" ${e.paid ? 'checked' : ''} onchange="toggleExpensePaid(${e.id})" style="flex-shrink:0;">
        <div style="flex:1; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:800; font-size:16px;" class="${textClass}">${e.name}</div>
          <div style="font-weight:900; font-size:18px;" class="${textClass}">${formatMoney(e.amount)}</div>
        </div>
        <button class="cancelBtn" style="border:none; padding:8px; font-size:16px; font-weight:bold; flex-shrink:0;" onclick="deleteExpense(${e.id})">âœ•</button>
      </div>
    `;
  });
  const tEl = document.getElementById("expensesTotal");
  if(tEl) tEl.textContent = formatMoney(totalUnpaid);
}

function showExpenseForm() { document.getElementById("addExpenseForm").style.display = "flex"; }
function hideExpenseForm() { document.getElementById("addExpenseForm").style.display = "none"; }

function saveExpense() {
  const name = document.getElementById("newExpenseName").value;
  const amount = parseFloat(document.getElementById("newExpenseAmount").value || 0);
  if (!name || amount <= 0) return alert("Please enter a valid expense name and amount.");
  
  const exps = getStorage("global_expenses", []);
  exps.push({ id: Date.now(), name, amount, paid: false });
  setStorage("global_expenses", exps);
  
  document.getElementById("newExpenseName").value = "";
  document.getElementById("newExpenseAmount").value = "";
  hideExpenseForm();
  renderExpenses();
}

function toggleExpensePaid(id) {
  const exps = getStorage("global_expenses", []);
  const e = exps.find(x => x.id === id);
  if (e) { e.paid = !e.paid; setStorage("global_expenses", exps); renderExpenses(); }
}

function deleteExpense(id) {
  if (!confirm("Remove this expense?")) return;
  let exps = getStorage("global_expenses", []);
  exps = exps.filter(x => x.id !== id);
  setStorage("global_expenses", exps);
  renderExpenses();
}

// ===== 8. SNAPSHOT TRACKER LOGIC (Inc. Savings Goals & Debt Payoff) =====
function updateSnapshotTracker(trackerId) {
  const activeMonth = getActiveMonth();
  const account = document.getElementById(`${trackerId}AccountSelect`).value;
  const amount = parseFloat(document.getElementById(`${trackerId}AmountInput`).value || 0);
  
  const key = `${trackerId}_${activeMonth}`;
  const data = getStorage(key, {});
  data[account] = amount;
  setStorage(key, data);
  
  document.getElementById(`${trackerId}AmountInput`).value = "";
  renderSnapshotList(trackerId);
  
  if (trackerId === 'assumptions') renderNetWorth();
  renderDashboard(); 
  
  if (trackerId === 'investment') setTimeout(() => renderSnapshotGraph('investment', 'investmentGraphContainer', '#2aa6ff'), 10);
  if (trackerId === 'debt') {
    setTimeout(() => renderSnapshotGraph('debt', 'debtGraphContainer', '#ff5c5c'), 10);
    loadPayoffBalance();
  }
  if (trackerId === 'savings') setTimeout(() => renderSnapshotGraph('savings', 'savingsGraphContainer', '#f5b942'), 10);
  if (['investment','debt','savings','assumptions'].includes(trackerId) && document.getElementById("pageNetworth").style.display === "block") {
    setTimeout(renderNetWorthGraph, 10);
  }
}

function renderSnapshotList(trackerId) {
  const activeMonth = getActiveMonth();
  const data = getStorage(`${trackerId}_${activeMonth}`, {});
  const list = document.getElementById(`${trackerId}List`);
  const totalEl = document.getElementById(`${trackerId}Total`);
  
  if (!list) return;
  list.innerHTML = "";
  let total = 0;
  
  Object.keys(data).forEach(acc => {
    const amt = data[acc];
    total += amt;
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<div style="font-weight:800;">${acc}</div><div>${formatMoney(amt)}</div>`;
    list.appendChild(row);
  });
  if(totalEl) totalEl.textContent = formatMoney(total);
  
  if(trackerId === 'savings') renderSavingsGoals();
}

// Savings Goals Math
function showGoalForm() { document.getElementById("addGoalForm").style.display = "flex"; }
function hideGoalForm() { document.getElementById("addGoalForm").style.display = "none"; }
function saveSavingsGoal() {
  const account = document.getElementById("goalAccountSelect").value;
  const label = document.getElementById("goalLabelInput").value;
  const target = parseFloat(document.getElementById("goalTargetInput").value || 0);
  
  if(!label || target <= 0) return alert("Enter valid goal name and target amount.");
  
  let goals = getStorage("savings_goals", {});
  goals[account] = { label, target };
  setStorage("savings_goals", goals);
  
  document.getElementById("goalLabelInput").value = "";
  document.getElementById("goalTargetInput").value = "";
  hideGoalForm();
  renderSavingsGoals();
}

function renderSavingsGoals() {
  const list = document.getElementById("savingsGoalsList");
  if(!list) return;
  
  const goals = getStorage("savings_goals", {});
  const currentSavings = getStorage(`savings_${getActiveMonth()}`, {});
  
  list.innerHTML = "";
  let hasGoals = false;
  
  Object.keys(goals).forEach(acc => {
    hasGoals = true;
    const g = goals[acc];
    const current = currentSavings[acc] || 0;
    const pct = g.target === 0 ? 0 : Math.min(100, Math.round((current / g.target) * 100));
    
    list.innerHTML += `
      <div style="margin-bottom:14px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
          <div style="font-weight:800; font-size:14px;">${g.label} <span style="font-size:10px; font-weight:normal; color:#9aa7b6;">(${acc})</span></div>
          <div style="font-weight:bold; font-size:13px;">${pct}%</div>
        </div>
        <div style="width:100%; background:#1b2533; border-radius:6px; height:8px; overflow:hidden;">
          <div style="width:${pct}%; background:#2bd576; height:100%;"></div>
        </div>
        <div style="text-align:right; font-size:11px; color:#9aa7b6; margin-top:4px;">${formatMoney(current)} / ${formatMoney(g.target)}</div>
      </div>
    `;
  });
  
  if(!hasGoals) list.innerHTML = "<div style='color:#9aa7b6; font-size:12px;'>No active goals.</div>";
}

// Debt Payoff Estimator Math
function loadPayoffBalance() {
  const account = document.getElementById("payoffAccountSelect").value;
  const currentDebt = getStorage(`debt_${getActiveMonth()}`, {});
  document.getElementById("payoffBalance").value = currentDebt[account] || "";
  document.getElementById("payoffResult").textContent = "";
}

function calculatePayoff() {
  let bal = parseFloat(document.getElementById("payoffBalance").value || 0);
  const rate = parseFloat(document.getElementById("payoffRate").value || 0);
  const minPmt = parseFloat(document.getElementById("payoffMin").value || 0);
  const extraPmt = parseFloat(document.getElementById("payoffExtra").value || 0);
  
  const resEl = document.getElementById("payoffResult");
  
  if(bal <= 0 || minPmt <= 0) {
    resEl.textContent = "Please enter valid balance and min payment.";
    resEl.style.color = "#ff5c5c";
    return;
  }
  
  let totalPmt = minPmt + extraPmt;
  let moRate = (rate / 100) / 12;
  
  if (rate > 0 && totalPmt <= bal * moRate) {
    resEl.textContent = "Payment is less than interest. You will never pay this off!";
    resEl.style.color = "#ff5c5c";
    return;
  }

  let months = 0;
  let totalInterest = 0;
  
  // Safe loop up to 50 years to prevent infinity crashes
  while (bal > 0 && months < 600) {
    let interest = bal * moRate;
    totalInterest += interest;
    let principal = totalPmt - interest;
    bal -= principal;
    months++;
  }

  if(months >= 600) {
    resEl.textContent = "Takes over 50 years to pay off.";
    resEl.style.color = "#ff5c5c";
    return;
  }

  const payoffDate = new Date();
  payoffDate.setMonth(payoffDate.getMonth() + months);
  const monthStr = payoffDate.toLocaleString('en-US', { month: 'short', year: 'numeric' });
  
  resEl.textContent = `Payoff Date: ${monthStr} (${months} mos)`;
  resEl.style.color = "#f5b942";
}

// ===== 9. FLOW TRACKER LOGIC =====
function toggleIncomeMisc() {
  const sel = document.getElementById("incomeAccountSelect");
  const misc = document.getElementById("incomeMiscInput");
  if(sel && misc) misc.style.display = sel.value === "Miscellaneous" ? "block" : "none";
}

function addFlowTransaction(trackerId) {
  const activeMonth = getActiveMonth();
  const account = document.getElementById(`${trackerId}AccountSelect`).value;
  const amount = parseFloat(document.getElementById(`${trackerId}AmountInput`).value || 0);
  const date = document.getElementById(`${trackerId}DateInput`).value;
  
  let desc = "";
  if(trackerId === 'income' && account === 'Miscellaneous') {
    desc = document.getElementById(`incomeMiscInput`).value;
  }

  if(!date || amount <= 0) return alert("Please enter a valid amount and date.");

  const key = `${trackerId}_${activeMonth}`;
  const data = getStorage(key, []);
  
  data.push({ id: Date.now(), account, desc, amount, date });
  data.sort((a, b) => a.date.localeCompare(b.date)); 
  
  setStorage(key, data);
  
  document.getElementById(`${trackerId}AmountInput`).value = "";
  if(trackerId === 'income') document.getElementById(`incomeMiscInput`).value = "";
  
  renderFlowList(trackerId);
  renderDashboard();
}

function deleteFlowTransaction(trackerId, id) {
  if(!confirm("Delete this entry?")) return;
  const key = `${trackerId}_${getActiveMonth()}`;
  let data = getStorage(key, []);
  data = data.filter(t => t.id !== id);
  setStorage(key, data);
  renderFlowList(trackerId);
  renderDashboard();
}

function renderFlowList(trackerId) {
  const activeMonth = getActiveMonth();
  const data = getStorage(`${trackerId}_${activeMonth}`, []);
  
  const list = document.getElementById(`${trackerId}TransactionList`);
  const totalEl = document.getElementById(`${trackerId}Total`);
  const catTotalsEl = document.getElementById(`${trackerId}CategoryTotals`);
  
  if(!list) return;
  list.innerHTML = "";
  
  let grandTotal = 0;
  let catTotals = {};
  
  DEFAULT_CATEGORIES[trackerId].forEach(c => catTotals[c] = 0);
  
  if(data.length === 0) {
    list.innerHTML = "<div style='color:#9aa7b6; font-size:12px; margin-top:10px;'>No entries recorded for this month.</div>";
  } else {
    data.forEach(txn => {
      grandTotal += txn.amount;
      if(catTotals[txn.account] !== undefined) catTotals[txn.account] += txn.amount;
      else catTotals[txn.account] = txn.amount;
      
      const title = txn.desc ? `${txn.account} (${txn.desc})` : txn.account;
      const dStr = new Date(txn.date + "T00:00:00").toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      
      list.innerHTML += `
        <div class="row" style="align-items:center;">
          <div style="flex:1;">
            <div style="font-weight:800;">${title}</div>
            <div style="font-size:11px; color:#2aa6ff; font-weight:bold; margin-top:2px;">${dStr}</div>
          </div>
          <div style="font-weight:900; font-size:16px;">${formatMoney(txn.amount)}</div>
          <button class="cancelBtn" style="border:none; padding:8px; font-weight:bold; font-size:16px;" onclick="deleteFlowTransaction('${trackerId}', ${txn.id})">âœ•</button>
        </div>
      `;
    });
  }
  
  if(totalEl) totalEl.textContent = formatMoney(grandTotal);
  
  if(catTotalsEl) {
    if(trackerId === 'retirement') {
      let rothTotal = 0;
      let tradTotal = 0;
      data.forEach(txn => {
        if(txn.account.toLowerCase().includes("roth")) rothTotal += txn.amount;
        else tradTotal += txn.amount;
      });
      catTotalsEl.innerHTML = `
        <div style='margin-bottom:8px; color:#9aa7b6; font-size:11px;'>SUBTOTALS BY TAX TYPE</div>
        <div style="display:flex; justify-content:space-between; margin-bottom:6px; font-weight:600; color:#2aa6ff;"><span>Roth Contributions</span><span>${formatMoney(rothTotal)}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-weight:600; color:#f5b942;"><span>Traditional / Pre-Tax</span><span>${formatMoney(tradTotal)}</span></div>
        <div style='margin-bottom:8px; color:#9aa7b6; font-size:11px;'>SUBTOTALS BY ACCOUNT</div>
      `;
    } else {
      catTotalsEl.innerHTML = "<div style='margin-bottom:8px; color:#9aa7b6; font-size:11px;'>SUBTOTALS BY SOURCE</div>";
    }

    let hasCategories = false;
    Object.keys(catTotals).forEach(c => {
      if(catTotals[c] > 0) {
        hasCategories = true;
        catTotalsEl.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:6px; font-weight:600;"><span>${c}</span><span>${formatMoney(catTotals[c])}</span></div>`;
      }
    });
    if(!hasCategories) catTotalsEl.innerHTML += "<div style='font-weight:500;'>--</div>";
  }
}

// ===== 10. GRAPH GENERATORS =====
function drawGraphSVG(container, history, color) {
  if (history.length < 1) {
    container.innerHTML = "<div style='color:#9aa7b6; font-size:12px; text-align:center; margin-top:40px;'>No data to graph yet.</div>";
    return;
  }
  const w = container.clientWidth || 300;
  const h = 160; 
  const padX = 40;
  const padY = 30;

  const minT = Math.min(...history.map(h => h.total));
  const maxT = Math.max(...history.map(h => h.total));
  const range = maxT - minT === 0 ? 1 : maxT - minT;

  let points = "";
  let labels = "";
  
  history.forEach((pt, i) => {
    const step = history.length <= 1 ? 1 : history.length - 1;
    const x = padX + (i * ((w - padX * 2) / step));
    const y = h - padY - ((pt.total - minT) / range) * (h - padY * 2);
    
    points += `${x},${y} `;
    
    const dateObj = new Date(pt.month + "-02"); 
    const monthStr = dateObj.toLocaleString('en-US', { month: 'short' });
    const yearStr = pt.month.substring(2, 4); 
    const labelText = `${monthStr} '${yearStr}`;
    
    labels += `<circle cx="${x}" cy="${y}" r="4" fill="${color}"/>`;
    labels += `<text x="${x}" y="${h - 5}" fill="#9aa7b6" font-size="12" font-weight="bold" text-anchor="middle">${labelText}</text>`;
    
    if(history.length <= 8) {
        labels += `<text x="${x}" y="${y - 12}" fill="#fff" font-size="11" font-weight="800" text-anchor="middle">$${Math.round(pt.total/1000)}k</text>`;
    }
  });

  container.innerHTML = `
    <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">
      <polyline points="${points.trim()}" fill="none" stroke="${color}" stroke-width="2"/>
      ${labels}
    </svg>
  `;
}

function renderSnapshotGraph(trackerId, containerId, color) {
  const container = document.getElementById(containerId);
  if (!container) return;

  let history = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(STORAGE_PREFIX + trackerId + "_")) {
      const month = key.split(trackerId + "_")[1];
      const data = JSON.parse(localStorage.getItem(key));
      const total = Object.values(data).reduce((a,b)=>a+b, 0);
      history.push({ month, total });
    }
  }
  history.sort((a,b) => a.month.localeCompare(b.month));
  drawGraphSVG(container, history, color);
}

function renderNetWorthGraph() {
  const container = document.getElementById("networthGraphContainer");
  if (!container) return;

  let monthsSet = new Set();
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(STORAGE_PREFIX)) {
      const parts = key.split('_');
      if(parts.length >= 3) monthsSet.add(parts[2]);
    }
  }
  
  let history = [];
  Array.from(monthsSet).forEach(month => {
    const assets = sumSnapshot('investment', month) + sumSnapshot('savings', month) + sumSnapshot('assumptions', month);
    const liab = sumSnapshot('debt', month);
    history.push({ month, total: assets - liab });
  });

  history.sort((a,b) => a.month.localeCompare(b.month));
  drawGraphSVG(container, history, '#2bd576');
}

// ===== 11. YEARLY REPORT ENGINE =====
function generateYearlyReport() {
  const year = document.getElementById("reportYearSelect").value;
  const container = document.getElementById("reportContainer");
  if (!container) return;
  
  const getYearlyFlow = (tracker) => {
    let total = 0;
    let rothTotal = 0;
    let tradTotal = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(`${STORAGE_PREFIX}${tracker}_${year}-`)) {
        const data = JSON.parse(localStorage.getItem(key)) || [];
        data.forEach(item => {
          total += item.amount;
          if(tracker === 'retirement') {
             if(item.account.toLowerCase().includes("roth")) rothTotal += item.amount;
             else tradTotal += item.amount;
          }
        });
      }
    }
    return { total, rothTotal, tradTotal };
  };

  const incomeYTD = getYearlyFlow('income').total;
  const taxYTD = getYearlyFlow('tax').total;
  const retFlow = getYearlyFlow('retirement');

  let monthsSet = new Set();
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(STORAGE_PREFIX)) {
      const parts = key.split('_');
      if(parts.length >= 3 && parts[2].startsWith(year + "-")) monthsSet.add(parts[2]);
    }
  }
  
  let startMonth = null, endMonth = null;
  let startInv = 0, endInv = 0, startDebt = 0, endDebt = 0, startNW = 0, endNW = 0;

  if (monthsSet.size > 0) {
    let months = Array.from(monthsSet).sort();
    startMonth = months[0];
    endMonth = months[months.length - 1];

    const getNW = (m) => sumSnapshot('investment', m) + sumSnapshot('savings', m) + sumSnapshot('assumptions', m) - sumSnapshot('debt', m);
    
    startInv = sumSnapshot('investment', startMonth);
    endInv = sumSnapshot('investment', endMonth);
    startDebt = sumSnapshot('debt', startMonth);
    endDebt = sumSnapshot('debt', endMonth);
    startNW = getNW(startMonth);
    endNW = getNW(endMonth);
  }

  let html = "";
  if (monthsSet.size === 0) {
    html = `<div style='color:#9aa7b6; text-align:center; padding: 20px;'>No data recorded for ${year}.</div>`;
  } else {
    html += `
      <div class="card">
        <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">CASH FLOW (${year})</div>
        <div class="row"><div>Gross Income</div><div style="font-weight:900;">${formatMoney(incomeYTD)}</div></div>
        <div class="row"><div>Taxes Withheld</div><div style="font-weight:900; color:#ff5c5c;">-${formatMoney(taxYTD)}</div></div>
        <div class="row" style="border-top:1px solid #1b2533; padding-top:12px;">
           <div style="font-weight:900;">NET TAKE-HOME</div>
           <div style="font-weight:900; font-size:18px; color:#2bd576;">${formatMoney(incomeYTD - taxYTD)}</div>
        </div>
      </div>

      <div class="card">
        <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">WEALTH BUILDING (${year})</div>
        <div class="row"><div>Retirement Contributions</div><div style="font-weight:900;">${formatMoney(retFlow.total)}</div></div>
        <div class="row" style="padding-top:0;"><div style="font-size:11px; color:#9aa7b6;">â†³ Roth</div><div style="font-size:12px;">${formatMoney(retFlow.rothTotal)}</div></div>
        <div class="row" style="padding-top:0;"><div style="font-size:11px; color:#9aa7b6;">â†³ Traditional</div><div style="font-size:12px;">${formatMoney(retFlow.tradTotal)}</div></div>
        
        <div style="height:1px; background:#1b2533; margin:10px 0;"></div>
        
        <div class="row"><div>Investment Growth</div><div style="font-weight:900; color:${endInv >= startInv ? '#2bd576' : '#ff5c5c'};">${endInv >= startInv ? '+' : ''}${formatMoney(endInv - startInv)}</div></div>
        <div class="row" style="padding-top:0;"><div style="font-size:11px; color:#9aa7b6;">â†³ Start to End</div><div style="font-size:12px;">${formatMoney(startInv)} â†’ ${formatMoney(endInv)}</div></div>
        
        <div style="height:1px; background:#1b2533; margin:10px 0;"></div>

        <div class="row">
           <div style="font-weight:900;">NET WORTH DELTA</div>
           <div style="font-weight:900; font-size:18px; color:${endNW >= startNW ? '#2bd576' : '#ff5c5c'};">${endNW >= startNW ? '+' : ''}${formatMoney(endNW - startNW)}</div>
        </div>
      </div>

      <div class="card">
        <div style="font-size:12px;color:#9aa7b6;margin-bottom:10px;">DEBT REDUCTION (${year})</div>
        <div class="row"><div>Debt Eliminated</div><div style="font-weight:900; color:#2aa6ff;">${formatMoney(startDebt - endDebt)}</div></div>
        <div class="row" style="padding-top:0;"><div style="font-size:11px; color:#9aa7b6;">â†³ Start to End</div><div style="font-size:12px;">${formatMoney(startDebt)} â†’ ${formatMoney(endDebt)}</div></div>
      </div>
    `;
  }
  container.innerHTML = html;
}

// ===== 12. DATA EXPORT / IMPORT ENGINE =====
function exportData() {
  let exportObj = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(STORAGE_PREFIX)) {
      exportObj[key] = localStorage.getItem(key);
    }
  }
  
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  const dateStr = new Date().toISOString().split('T')[0];
  downloadAnchorNode.setAttribute("download", `BillsOps_Backup_${dateStr}.json`);
  document.body.appendChild(downloadAnchorNode); // required for firefox
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
}

function importData() {
  const fileInput = document.getElementById('importFileInput');
  if(!fileInput.files.length) return alert("Please select a backup file first.");
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      if(!confirm("Warning: This will overwrite your current app data. Proceed?")) return;
      
      // Wipe current v12 data
      let keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        if(localStorage.key(i).startsWith(STORAGE_PREFIX)) keysToRemove.push(localStorage.key(i));
      }
      keysToRemove.forEach(k => localStorage.removeItem(k));
      
      // Load imported data
      Object.keys(importedData).forEach(key => {
        if(key.startsWith(STORAGE_PREFIX)) {
           localStorage.setItem(key, importedData[key]);
        }
      });
      
      alert("Import successful! The app will now reload.");
      location.reload();
      
    } catch(err) {
      alert("Invalid backup file.");
    }
  };
  reader.readAsText(file);
}

// ===== 13. NAVIGATION & INIT =====
function toggleMenu() {
  const back = document.getElementById("menuBackdrop");
  const drawer = document.getElementById("menuDrawer");
  const isHidden = drawer.style.display === "none";
  drawer.style.display = isHidden ? "block" : "none";
  back.style.display = isHidden ? "block" : "none";
}

function navigateTo(pageId) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  const target = `page${pageId.charAt(0).toUpperCase() + pageId.slice(1)}`;
  const el = document.getElementById(target);
  if (el) el.style.display = "block";
  else document.getElementById("pageHome").style.display = "block";
  
  document.getElementById("menuDrawer").style.display = "none";
  document.getElementById("menuBackdrop").style.display = "none";
  
  if (['debt', 'investment', 'savings', 'assumptions'].includes(pageId)) renderSnapshotList(pageId);
  if (['income', 'tax', 'retirement'].includes(pageId)) renderFlowList(pageId);
  if (pageId === 'networth') renderNetWorth();
  if (pageId === 'expenses') renderExpenses();
  if (pageId === 'report') generateYearlyReport();
  
  if (pageId === 'investment') setTimeout(() => renderSnapshotGraph('investment', 'investmentGraphContainer', '#2aa6ff'), 10);
  if (pageId === 'debt') {
    setTimeout(() => renderSnapshotGraph('debt', 'debtGraphContainer', '#ff5c5c'), 10);
    loadPayoffBalance();
  }
  if (pageId === 'savings') setTimeout(() => renderSnapshotGraph('savings', 'savingsGraphContainer', '#f5b942'), 10);
  if (pageId === 'networth') setTimeout(renderNetWorthGraph, 10);
}

document.addEventListener("DOMContentLoaded", () => {
  initActiveMonthUI();
  const initialMonth = getActiveMonth();
  initTrackersForMonth(initialMonth);
  renderBills();
  renderExpenses();
  renderNetWorth();
  
  const todayStr = new Date().toISOString().split('T')[0];
  const incDate = document.getElementById("incomeDateInput");
  if(incDate) incDate.value = todayStr;
  const taxDate = document.getElementById("taxDateInput");
  if(taxDate) taxDate.value = todayStr;
  const retDate = document.getElementById("retirementDateInput");
  if(retDate) retDate.value = todayStr;
});
</script>